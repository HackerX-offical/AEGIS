import { SecurityTool, ToolCategory } from "../../types/ToolInterfaces";
import { SimulationUtils } from "../../utils/SimulationUtils";
import colors from "colors";
import { ConsoleManager } from "../../ui/ConsoleManager";
import { Panel } from "../../ui/widgets/Panel";
import { LogStream } from "../../ui/widgets/LogStream";
import readline from "readline";

// 1. Malware Sandbox (Advanced VM Monitor) - INTERACTIVE REBUILD
export class MalwareSandboxTool implements SecurityTool {
  id = "sandbox";
  name = "Malware Sandbox";
  category = ToolCategory.MALWARE;
  description = "Safe execution of suspicious binaries";

  private console: ConsoleManager = new ConsoleManager();

  async execute(args: string[]): Promise<void> {
    this.console.clear();
    const width = process.stdout.columns || 80;
    const height = process.stdout.rows || 24;

    const mainPanel = new Panel(
      1,
      4,
      width,
      height - 5,
      "Secure Sandbox: VM-Alpha"
    );
    // Telemetry Panel
    const telemetryPanel = new Panel(3, 6, width - 6, 6, "VM Telemetry");
    // Activity Log
    const logPanel = new LogStream(3, 14, width - 6, height - 16);

    mainPanel.render();
    telemetryPanel.render();

    this.console.printAt(5, 8, "Sample: suspicious_invoice.exe");
    this.console.printAt(5, 9, "MD5:    e2fc71b8...9a2");

    // Simulation Loop
    let updates = 20;
    if (args.length > 0) updates = 2; // Fast mode for verification

    for (let i = 0; i <= updates; i++) {
      await this.sleep(SimulateRandomTime(200, 800));

      // Update Gauges
      const cpu = Math.floor(Math.random() * 90) + 10;
      const ram = Math.floor(Math.random() * 60) + 20; // %
      this.renderGauge(50, 8, "CPU", cpu);
      this.renderGauge(50, 9, "RAM", ram);

      // Events
      if (i === 2) logPanel.addLog("Booting Windows 11 Guest OS...");
      if (i === 5) logPanel.addLog("Injecting sample into user space...");
      if (i === 8)
        logPanel.addLog("[!] Process spawned: cmd.exe /c powershell");
      if (i === 12)
        logPanel.addLog("[!] Registry Key Modified: HKCU\\...\\Run");
      if (i === 15)
        logPanel.addLog("[!] Outbound Connection blocked: 192.168.x.x");
      if (i === 19) logPanel.addLog("Sample Terminated. Report Generated.");

      // Random "System Call" noise
      if (Math.random() > 0.6) {
        const syscalls = [
          "NtCreateFile",
          "NtWriteVirtualMemory",
          "RegSetValueEx",
          "SocketConnect",
        ];
        const call = syscalls[Math.floor(Math.random() * syscalls.length)];
        logPanel.addLog(
          `SYSCALL > ${call} (Handle: 0x${Math.floor(
            Math.random() * 1000
          ).toString(16)})`
        );
      }
    }

    this.console.printAt(
      3,
      height - 2,
      colors.gray("Analysis Complete. Press Enter to exit...")
    );
    if (args.length === 0) {
      await this.waitForKey();
    }
  }

  private renderGauge(
    x: number,
    y: number,
    label: string,
    value: number
  ): void {
    const bars = Math.floor(value / 5); // 20 chars max
    const empty = 20 - bars;
    const color =
      value > 80 ? colors.red : value > 50 ? colors.yellow : colors.green;

    this.console.printAt(
      x,
      y,
      `${label}: [${color("█".repeat(bars))}${" ".repeat(empty)}] ${value}%`
    );
  }

  private waitForKey(): Promise<void> {
    return new Promise((resolve) => {
      process.stdin.once("data", () => resolve());
    });
  }

  private sleep(ms: number): Promise<void> {
    return new Promise((r) => setTimeout(r, ms));
  }
}

function SimulateRandomTime(min: number, max: number): number {
  return Math.floor(Math.random() * (max - min) + min);
}

export class BehaviorVisualizerTool implements SecurityTool {
  id = "behavior";
  name = "Behavior Visualizer";
  category = ToolCategory.MALWARE;
  description = "Shows what malware tries to do";
  async execute(args: string[]): Promise<void> {
    console.log(colors.cyan("Visualizing system calls tree..."));
    await SimulationUtils.sleep(300);
    console.log("├── suspicious.exe");
    console.log("│   ├── cmd.exe /c powershell -enc ...");
    console.log(
      "│   └── reg.exe ADD HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
    );
    console.log(colors.yellow("Heuristic: Persistence Mechanism Detected."));
  }
}

export class BinaryExplainerTool implements SecurityTool {
  id = "binexplain";
  name = "Binary Explainer AI";
  category = ToolCategory.MALWARE;
  description = "Converts assembly to human explanation";
  async execute(args: string[]): Promise<void> {
    await SimulationUtils.logThinking("BinaryDecoder", [
      "Parsing ELF header...",
      "Disassembling .text section...",
      "Mapping syscalls",
    ]);
    console.log(colors.white("\nExplanation:"));
    console.log("The binary attempts to open '/etc/shadow' (Password hashes).");
    console.log("If successful, it sends the content to a remote socket.");
  }
}

export class ThreatClassifierTool implements SecurityTool {
  id = "classifier";
  name = "Threat Family Classifier";
  category = ToolCategory.MALWARE;
  description = "Categorizes malware types";
  async execute(args: string[]): Promise<void> {
    await SimulationUtils.progressBar("Matching Signatures", 600);
    console.log(colors.green("Match Found!"));
    console.log("Family:   WannaCry.B");
    console.log("Type:     Ransomware");
    console.log("Confidence: 99.8%");
  }
}

export class SignatureGeneratorTool implements SecurityTool {
  id = "siggen";
  name = "Signature Generator";
  category = ToolCategory.MALWARE;
  description = "Create detection rules (YARA)";
  async execute(args: string[]): Promise<void> {
    console.log(
      colors.cyan("Generating YARA Rule based on current artifacts...")
    );
    console.log(
      colors.white("--------------------------------------------------")
    );
    console.log("rule GEN_Ransomware_BitPay {");
    console.log("    strings:");
    console.log(`        $s1 = "bitcoin" nocase`);
    console.log(`        $hex1 = { E2 34 A1 C8 23 }`);
    console.log("    condition:");
    console.log("        all of them");
    console.log("}");
    console.log(
      colors.white("--------------------------------------------------")
    );
  }
}
